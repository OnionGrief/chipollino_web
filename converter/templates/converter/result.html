{% extends 'base/base.html' %}

{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/object_view.css' %}">
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}

{% block content %}

<div id="loading-spinner"></div>

<a href="{% url 'converter:index' %}">Назад</a>

{% csrf_token %}

<p class="large_text">Result</p>
<pre>{{test}}</pre>

{% if success|default:False %}
<label for="block-selector">Формат отображения:</label>
<select id="block-selector">
    <option value="blockpdf">PDF</option>
    <option value="blocklatex">LaTeX</option>
    <option value="blockhtml" selected>HTML</option>
</select>

<div class="resultblock" id="blockpdf" style="display: none;">
    <iframe src="{% url 'converter:pdf_view' %}" width="100%" height="1000px"></iframe></div>
<div class="resultblock" id="blocklatex" style="display: none;">
    <a id="tex-download" href="#" download="report.tex">Скачать report.tex</a>
    <pre id="tex-content" style="border: 1px solid rgb(160, 160, 160);">{{texresult}}</pre>
</div>
<div class="resultblock" id="blockhtml" style="display: block;">
    <div id="htmlres" style="display: flex; flex-direction: column;">
        {% for elem in result_list %}
        {% if elem.type == 'automaton' %}
        {% include 'converter/automaton_view.html' with format_list=elem.res.formats svg_graph=elem.res.svg %}
        {% elif elem.type == 'table' %}
        {% include 'converter/table_view.html' with format_list=elem.res.formats table=elem.res.data %}
        {% elif elem.type == 'plot' %}
        <div style="width: 50%">
            {{elem.res|safe}}
        </div>
        {% else %}
        {{elem.res|safe}}
        {% endif %}
        {% empty %}
        No content to show.
        {% endfor %}
    </div>
</div>
{% endif %}

<script>
    const spinner = document.getElementById('loading-spinner');

    const blockSelector = document.getElementById('block-selector');
    blockSelector.addEventListener('change', (event) => {
        const selectedValue = event.target.value;

        const blocks = document.querySelectorAll('.resultblock');
        for (const block of blocks) {
            if (block.id == selectedValue) {
                block.style.display = 'block';
            } else {
                block.style.display = 'none';
            }
        }
    });


    var tex_content = document.getElementById("tex-content").innerHTML;
    var downloadLink = document.getElementById("tex-download");
    downloadLink.href = "data:application/tex;charset=utf-8," + encodeURIComponent(tex_content);


    const automata = document.querySelectorAll('.object_view');
    automata.forEach(element => {
        element.querySelector('.format-selector').addEventListener('change', (event) => {
            const selectedValue = event.target.value;
            const blocks = element.querySelectorAll('.object_format');

            for (const block of blocks) {
                if (block.dataset.value == selectedValue) {
                    block.style.display = 'block';
                } else {
                    block.style.display = 'none';
                }
            }
        })

        element.querySelector('.get_tex_view').addEventListener('click', (event) => {
            // анимация загрузки
            spinner.style.display = 'block';

            tex_content = "";
            for (const block of element.querySelectorAll('.object_format')) {
                if (block.dataset.value == 'LaTeX') {
                    tex_content = block.textContent;
                }
            }
            fetch('/tikz_view/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]')
                            .value
                    },
                    body: JSON.stringify({
                        "tex_content": tex_content
                    })
                })
                .then(response => response.text())
                .then(data => {
                    element.querySelector('.object_figure').innerHTML = data;
                    element.querySelector('.get_tex_view').disabled = true;
                })
                .catch(error => console.error('Error getting SVG from TEX:', error))
                .finally(() => {
                    spinner.style.display = 'none';
                });
        });
    });
</script>

{% endblock %}
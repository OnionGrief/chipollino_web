{% extends 'base/base.html' %}

{% load static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/automaton_view.css' %}">
{% endblock %}

{% block content %}

<a href="{% url 'converter:index' %}">Назад</a>

<p class="large_text">Result</p>
<pre>{{res}}</pre>

{% if success|default:False %}
    <label for="block-selector">Формат отображения:</label>
    <select id="block-selector">
        <option value="blockpdf">PDF</option>
        <option value="blocklatex">LaTeX</option>
        <option value="blockhtml" selected>HTML</option>
    </select>

    <div class="resultblock" id="blockpdf" style="display: none;">
        <iframe src="{% url 'converter:pdf_view' %}" width="100%" height="1000px"></iframe></div>
    <div class="resultblock" id="blocklatex" style="display: none;">
        <a id="tex-download" href="#" download="text.tex">Скачать report.tex</a>
        <pre id="tex-content" style="border: 1px solid rgb(160, 160, 160);">{{texresult}}</pre>
    </div>
    <div class="resultblock" id="blockhtml" style="display: block;">
        <div style="display: flex; flex-direction: column;">
        {% for elem in result_list %}
        {% if elem.type == 'automaton' %}
        {% include 'converter/automaton_view.html' with format_list=elem.res %}
        {% else %}
        {{elem.res|safe}}
        {% endif %}
        {% empty %}
        No content to show.
        {% endfor %}
    </div>
</div>
{% endif %}

<script>
    const blockSelector = document.getElementById('block-selector');
    blockSelector.addEventListener('change', (event) => {
        const selectedValue = event.target.value;

        const blocks = document.querySelectorAll('.resultblock');
        for (const block of blocks) {
            if (block.id == selectedValue) {
                block.style.display = 'block';
            } else {
                block.style.display = 'none';
            }
        }
    });

    
    var tex_content = document.getElementById("tex-content").innerHTML;
    var downloadLink = document.getElementById("tex-download");
    downloadLink.href = "data:application/tex;charset=utf-8," + encodeURIComponent(tex_content);


    const automata = document.querySelectorAll('.automaton_view');
    automata.forEach(element => {
        const blocks = element.querySelectorAll('.automaton_format');
        for (const block of blocks) {
            if (block.dataset.value == 'LaTeX') {
                block.style.display = 'block';
            }
        }
        element.querySelectorAll('.format-selector').forEach(selector => {
            selector.addEventListener('change', (event) => {
                const selectedValue = event.target.value;
                const blocks = element.querySelectorAll('.automaton_format');

                for (const block of blocks) {
                    if (block.dataset.value == selectedValue) {
                        block.style.display = 'block';
                    } else {
                        block.style.display = 'none';
                    }
                }
            })
        });
    });
</script>

{% endblock %}
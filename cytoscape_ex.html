<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph Visualization with Cytoscape.js</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.29.2/cytoscape.min.js"></script>
    <style>
        #cy {
            width: 800px;
            height: 600px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Graph Visualization with Cytoscape.js</h1>
    <div id="cy"></div>
    <button onclick="addNode()">Add Node</button>
    <button onclick="addEdge()">Add Edge</button>
    <button onclick="changeFinality()">Change Finality</button>


    <script>
    
    const graphData = {
        nodes: [
            { data: { id: 'dummy', label: ''}, classes: 'dummy'}, 
            { data: { id: 'start', label: 'Start' }},
            { data: { id: 'a', label: 'Node AAAAAAAAA' } },
            { data: { id: 'b', label: 'B' } },
            { data: { id: 'c', label: 'Node C' }, classes: 'doublecircle' },
            { data: { id: 'd', label: 'Node D' } },
            { data: { id: 'e', label: 'E' } },
            { data: { id: 'h', label: 'H' } },
        ],
        edges: [
        { data: { source: 'dummy', target: 'start', label: ''} },
        { data: { source: 'start', target: 'a', label: 'ε' } },
            { data: { source: 'a', target: 'a', label: 'A to A' } },
            { data: { source: 'b', target: 'b', label: 'B to B' } },
            { data: { source: 'a', target: 'b', label: 'A to B' } },
            { data: { source: 'b', target: 'd', label: 'bd' } },
            { data: { source: 'a', target: 'c', label: 'A to C' } },
            { data: { source: 'b', target: 'd', label: 'B to D' } },
            { data: { source: 'c', target: 'd', label: 'C to D' } },
            { data: { source: 'd', target: 'e', label: 'de' } },
            { data: { source: 'e', target: 'h', label: 'eh' } },
        ]
    };

    const cy = cytoscape({
        container: document.getElementById('cy'), 
        elements: graphData,
        style: [
            {
                selector: 'node',
                style: {
                    'background-color': '#ffffff',
                    'border-width': 1,
                    'label': 'data(label)',
                    'text-valign': 'center',
                    'font-size': '10px',
                    'shape': 'ellipse'
                }
            },
            {
                selector: 'node.dummy',
                style: {
                    'border-width': 0,
                }
            },
            {
                selector: 'node.doublecircle',
                style: {
                    'border-width': 3,
                    'border-style': 'double',
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 1,
                    'line-color': '#000',
                    'target-arrow-color': '#000',
                    'target-arrow-shape': 'vee',
                    'curve-style': 'bezier',
                    'label': 'data(label)',
                    'font-size': '10px',
                    'text-rotation': 'autorotate',
                    'text-margin-y': -10,
                    'color': '#000',
                    'loop-direction': '0deg',
                    'loop-sweep': '25deg',
                    'z-index': 2
                }
            }
        ]});

    layout_settings = {
        name: 'breadthfirst',
        directed: true,
        spacingFactor: 1,
        transform: function (node, position) {
            return {x: position.y, y: position.x}; // Swap x and y to make it horizontal
        }
    }
    var dummyId = 'dummy';
    var startId = null;

    cy.layout(layout_settings).run();

    function set_size(node) {
        const labelLength = node.data('label').length;
        const width = Math.max(20, Math.min(50, labelLength * 7));
        node.style('width', width);
        node.style('height', width);
    }

    cy.nodes().forEach(function (node) {
        set_size(node);
    });
    cy.edges().forEach(function (edge) {
        if (edge.source().id() == dummyId)
            startId = edge.target().id();
    });

    
    function lockGraph() {
        cy.nodes().forEach(function(node) {
            node.lock();
        });
    }
    function unlockGraph() {
        cy.nodes().forEach(function(node) {
            node.unlock();
        });
    }

    var sourceNode = null;
    var targetNode = null;
    var selectedElement = null;

    // Обработчик выбора узлов
    cy.on('tap', 'node', function(event) {
        var node = event.target;
        if (node.id() == dummyId)
            return;
        if (sourceNode === null && targetNode === null) {
            sourceNode = node;
            sourceNode.style('border-color', 'green');
        } else if (targetNode === null && sourceNode != null) {
            targetNode = node;
            targetNode.style('border-color', 'red');
        } else if (sourceNode != null && targetNode != null) {
            sourceNode.style('border-color', 'black');
            targetNode.style('border-color', 'black');
            targetNode = null;
            sourceNode = node;
            sourceNode.style('border-color', 'green');
        }
        selectedElement = node;
    });

    cy.on('tap', 'edge', function(event) {
        if (event.target.source().id() == dummyId)
            return;
        selectedElement = event.target;
    });

    document.addEventListener('keydown', function(event) {
        if (event.key === 'Delete' && selectedElement && selectedElement.id() != startId) {
            lockGraph()
            if (selectedElement == sourceNode)
                sourceNode = null;
            if (selectedElement == targetNode)
                targetNode = null;
            cy.remove(selectedElement);
            selectedElement = null;
            cy.layout(layout_settings).run();
            unlockGraph()
        }
    });



    function addNode() {
        nodeId = prompt('Enter node id:');
        if (!nodeId)
            return;
        lockGraph();
        let start_pos = cy.getElementById(startId).position();
        a = cy.add({
            group: 'nodes',
            data: { id: nodeId, label: nodeId},
            position: {x: start_pos.x, y: start_pos.y - 100},
            locked: true,
        });
        set_size(a);
        cy.layout(layout_settings).run();
        unlockGraph();
    }

    function addEdge() {
        if (sourceNode != null && targetNode != null) {
            label = prompt('Enter edge label');
            if (label == null)
                return;
            lockGraph();
            cy.add({
                group: 'edges',
                data: { source: sourceNode.id(), target: targetNode.id(), label: label },
                
            });
            sourceNode.style('border-color', 'black');
            targetNode.style('border-color', 'black');
            cy.layout(layout_settings).run();
            unlockGraph();
        }
    }
    
    function changeFinality() {
        if (selectedElement != null && selectedElement.isNode())
            if (selectedElement.classes().includes('doublecircle')) 
                selectedElement.removeClass('doublecircle');
            else 
                selectedElement.addClass('doublecircle');
}

function getGraphJSON() {
            // Получение всех узлов и ребер
            var nodes = cy.nodes().map(function(node) {
                node_info = {
                    data: {
                        id: node.data('id'),
                        label: node.data('label')
                    }
                };
                if (node.classes().length > 0)
                    node_info['classes'] = node.classes()[0]
                return node_info;
            });

            var edges = cy.edges().map(function(edge) {
                return {
                    data: {
                        source: edge.data('source'),
                        target: edge.data('target'),
                        label: edge.data('label')
                    }
                };
            });

            return JSON.stringify({nodes: nodes, edges: edges}, null, 2);
        }

        cy.ready(function() {
            var jsonGraph = getGraphJSON();
            console.log("Graph JSON:", jsonGraph);
        });

    </script>
</body>
</html>
